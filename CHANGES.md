# سجل التغييرات (Changelog)

جميع التغييرات الهامة في هذا البوت سيتم توثيقها في هذا الملف.

## [1.1.0] - 2026-01-10

### الإصلاحات (Bug Fixes)
- ✅ **تحسين معالجة الأخطاء الشبكية**:
  - إضافة آلية إعادة المحاولة (Retry Mechanism)
  - يُعيد محاولة الإرسال حتى 3 مرات
  - ينتظر ثانيتين بين كل محاولة
  - يُميز بين الأخطاء الشبكية والأخطاء الأخرى
  - لا يُظهر رسائل خطأ للمستخدم عند مشاكل الشبكة المؤقتة

### التحسينات (Enhancements)
- ✅ **دالة `send_message_safe()` الجديدة**:
  - إرسال آمن مع إعادة المحاولة التلقائية
  - تحسين استقرار البوت
  - تسجيل شامل لجميع المحاولات
  - سهولة الصيانة

- ✅ **تحديث الدوال الحالية**:
  - `handle_rules()` - استخدام `send_message_safe()`
  - `send_content_message()` - استخدام `send_message_safe()`

- ✅ **ثوابت جديدة للتحكم**:
  - `MAX_RETRIES = 3` - عدد المحاولات القصوى
  - `RETRY_DELAY = 2` - تأخير بين المحاولات

### الملفات المعدلة
- `bot.py` - إضافة `send_message_safe()` وتحديثات
- `NETWORK_IMPROVEMENTS.md` - ملف جديد يشرح التحسينات
- `CHANGES.md` - تحديث بهذا الإصدار

### التوثيق
- دليل شامل للتحسينات في `NETWORK_IMPROVEMENTS.md`
- توضيح كيفية العمل مع الأمثلة
- نصائح للاستخدام والتخصيص

---

## [1.0.1] - 2024-01-10

### الميزات الجديدة (New Features)
- ✅ **نظام جدولة المحتوى الذكي**:
  - إرسال المحتوى الديني (أذكار وأحاديث) تلقائياً في أوقات محددة
  - كل مجموعة لها توقيتها الخاص
  - منع التكرار في نفس اليوم
  - 9 فئات محتوى مختلفة

- ✅ **فئات المحتوى الجديدة**:
  - `morning_athkar` - أذكار الصباح
  - `evening_athkar` - أذكار المساء
  - `hadiths` - أحاديث عامة
  - `hadiths_dunya` - أحاديث عن الدنيا
  - `hadiths_hub` - أحاديث عن الحب
  - `hadiths_akhlaq` - أحاديث عن الأخلاق
  - `hadiths_sabr` - أحاديث عن الصبر
  - `hadiths_jannah` - أحاديث عن الجنة
  - `hadiths_qudsi` - أحاديث قدسية

- ✅ **أوامر المحتوى الجديدة**:
  - `/contentstatus` - عرض جدول المحتوى وحالته
  - `/sendcontent` - إرسال محتوى عشوائي فوراً

- ✅ **المجدول الذكي**:
  - يعمل في خيط (thread) منفصل
  - يدور كل 60 ثانية
  - يتحقق من التوقيت حسب توقيت كل مجموعة
  - نافذة زمنية 2 دقيقة للإرسال

- ✅ **منع التكرار**:
  - استخدام `content_sent_log` لتتبع المحتوى المرسل
  - مرة واحدة يومياً لكل نوع محتوى

### التحسينات (Enhancements)
- ✅ **محتوى ديني غني**:
  - إضافة 9 فئات محتوى
  - أكثر من 20 نص إسلامي متنوع
  - تصميم جميل مع emojis

- ✅ **تحكم كامل**:
  - إمكانية تفعيل/تعطيل أي فئة
  - تعديل الأوقات في `content.json`
  - سهولة التخصيص

### الملفات المعدلة
- `content.json` - تحديث كامل مع فئات وجدول جديد
- `bot.py` - إضافة نظام جدولة المحتوى
- `CONTENT_SCHEDULER.md` - ملف جديد يشرح نظام الجدولة

---

## [1.0.1] - 2024-01-10

### الإصلاحات (Bug Fixes)
- ✅ **إصلاح مشكلة Telegram API Error 400**: عند اختيار نفس المدينة مرة أخرى، كان البوت يرسل خطأ "message is not modified". تم إصلاح هذا بـ:
  - التحقق من أن المدينة المختارة مختلفة عن المدينة الحالية قبل تعديل الرسالة
  - عرض تنبيه للمستخدم عند اختيار نفس المدينة بدلاً من خطأ

### التحسينات (Enhancements)
- ✅ **إضافة Cache لتقليل الطلبات المتكررة**:
  - تم إضافة `fetch_cache` لتتبع آخر وقت تم فيه جلب الأوقات لكل مجموعة
  - يمنع الطلبات المتكررة في غضون 5 ثوانٍ لنفس المجموعة
  - يقلل الحمل على API ويحسن الأداء

- ✅ **تحسين معالجة الأخطاء**:
  - تحسين معالجة Network Errors
  - إضافة تسجيل أفضل للأخطاء
  - منع توقف البوت بسبب أخطاء الشبكة

### الملفات المعدلة
- `bot.py` - تحديث دالة `handle_city_selection` و `fetch_and_save_prayer_times`
- `README.md` - إضافة قسم التحديثات الأخيرة
- `.env.example` - ملف جديد كنموذج للمتغيرات البيئية

---

## [1.0.0] - 2024-01-10

### الإصدار الأولي
- ✅ دعم متعدد المجموعات
- ✅ جلب أوقات الصلاة من Aladhan API
- ✅ حفظ الأوقات في قاعدة البيانات SQLite
- ✅ خدمة أذان ذكية لكل مجموعة
- ✅ منع تكرار الإشعارات
- ✅ نظام تسجيل الصلوات والنقاط
- ✅ محتوى ديني (أذكار وأحاديث)
- ✅ الأوامر الأساسية: `/start`, `/setup`, `/setgroupcity`, `/groupstatus`, `/prayed`, `/top`, `/rules`, `/help`

---

## التنسيق

### أنواع التغييرات
- **إضافة**: ميزة جديدة
- **تغيير**: تغيير في ميزة موجودة
- **إزالة**: إزالة ميزة
- **إصلاح**: إصلاح bug
- **تحسين**: تحسين في الأداء أو الكود
